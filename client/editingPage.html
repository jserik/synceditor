<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--<link rel="stylesheet" href="editingPage.css">-->
    <!--<script src="editingPage.js"></script>-->
    <title>Real Time Texteditor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

        body{
            background-color: white; 
            margin: 25px;
        }

        h1{
            margin-bottom: 0px;
            color: black; 
            align-content: center; 
            font-family: 'Roboto Mono', monospace;
        }

        #ErrorParag{
            margin-top: 0px;
            font-family: 'Roboto Mono', monospace;
        }

        #textarea{
            width: 100%; 
            height: 90vh; 
            color: black; 
            font-size:20px; 

            border: 5px solid;
            border-radius: 5px;
        } 
    </style>
    <script>
        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        })
        const ID = params.id
        const NAME = params.name
        //console.log(String(ID)+" "+String(NAME))

        const xhr =  new XMLHttpRequest();

        last_input = ""
                
        $( document ).ready(function() {
            xhr.open('POST', '/api/retrieve', false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify({"id":ID, "name":NAME}));
            response = JSON.parse(xhr.responseText);
            //console.log(response);
            if(response.status==="error"){
                $('#ErrorParag').text(response.error)
                $("#ErrorParag").css('color', 'red');
            } else if(response.status==="success"){
                $('#textarea').text(response.data)
            }
        });

        //paar Bugs, aber nichts bedeutendes
        function compareString(x, y){ //x = uhrsprünglich, y = neu => 
            if(x.length>y.length){ //kleinerer String => wurde gekürzt x>y
                for(let i = 0; i<x.length; i++){
                    //console.log(String(x)+" "+String(y[i])+" --- "+String(x.length)+" "+String(i)) //kleiner Bug bei der Darstellung wird der gesamte Text angezeigt
                    if(x[i]!==y[i]){
                        return {"pos":String(i),"change":String(-1),"char":String(x[i])}
                    }
                    else if(i===x.length-1){
                        return {"pos":String(i+1),"change":String(-1),"char":String(x[x.length])}
                    }
                }
                
            }
            else if(x.length<y.length){ //kleinerer String => wurde verländert x<y
                for(let i = 0; i<y.length; i++){
                    //console.log(String(x[i])+" "+String(y[i])+" --- "+String(y.length)+" "+String(i))
                    if(x[i]!==y[i]){
                        return {"pos":String(i),"change":String(1),"char":String(y[i])}
                    }
                    else if(i===y.length-1){
                        return {"pos":String(i+1),"change":String(1),"char":String(y[y.length])}
                    }
                }
            }
            return {"Error":"Something went completely wrong"} 
        }

        function onTextUpdate(e){
            clearInterval(load_data); // stop the interval, which loads the data from the server
            let results = compareString(last_input, e.value)
            //console.log(results)
            globalThis.last_input = e.value;

            send_data = JSON.stringify({"update":results, "id":ID, "name":NAME}) // {"update":{"pos": ..., "change": ..., "char": ...}, "id": ... , "name": ... }
            //console.log("Data which is gonna be send:")
            console.log(send_data)
            
            //post the results to back end
            xhr.open('POST', '/api/update', false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(send_data);
            response = JSON.parse(xhr.responseText);
            console.log(response);
            if(response.status==="failure"){
                $('#ErrorParag').text(response.error)
                $("#ErrorParag").css('color', 'red');
            } else if(response.status==="success"){
                $('#ErrorParag').text("success")
                $("#ErrorParag").css('color', 'green');
            }

            let load_data = setInterval(loadData, 1000) // restart the interval
        }
        
        const loadData = function(){
            console.log("get data from server")
            xhr.open('POST', '/api/retrieve', false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify({"id":ID, "name":NAME}));
            response = JSON.parse(xhr.responseText);
            console.log(response);
            if(response.status==="failure"){
                $('#ErrorParag').text(response.error)
                $("#ErrorParag").css('color', 'red');
            } else if(response.status==="success"){
                $('#textarea').text(response.data)
            }
        }

        let load_data = setInterval(loadData, 1000)

    
    </script>
</head>
<body>
    <h1>Real Time Texteditor</h1>
    <p id="ErrorParag"></p>
    <textarea id="textarea" placeholder="Just write ..." oninput="onTextUpdate(this)"></textarea>
</body>
</html>