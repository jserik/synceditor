<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<link rel="stylesheet" href="editingPage.css">-->
    <!--<script src="editingPage.js"></script>-->
    <title>Real Time Texteditor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

        h1{
            color: white; 
            align-content: center; 
            font-family: 'Roboto Mono', monospace;
        }

        #textarea{
            width: 100%; 
            height: 90vh; 
            color: black; 
            font-size:20px; 
            border-radius: 17px;
        } 
    </style>
    <script>
        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });
        const ID = params.id; // "some_value"
        console.log(ID)

        const xhr =  new XMLHttpRequest();

        last_input = ""
        
        //paar Bugs, aber nichts bedeutendes
        function compareString(x, y){ //x = uhrsprünglich, y = neu => 
            if(x.length>y.length){ //kleinerer String => wurde gekürzt x>y
                for(let i = 0; i<x.length; i++){
                    //console.log(String(x)+" "+String(y[i])+" --- "+String(x.length)+" "+String(i)) //kleiner Bug bei der Darstellung wird der gesamte Text angezeigt
                    if(x[i]!==y[i]){
                        return {"Pos":String(i),"Change":String(-1),"Char":String(x[i])}
                    }
                    else if(i===x.length-1){
                        return {"Pos":String(i+1),"Change":String(-1),"Char":String(x[x.length])}
                    }
                }
                
            }
            else if(x.length<y.length){ //kleinerer String => wurde verländert x<y
                for(let i = 0; i<y.length; i++){
                    //console.log(String(x[i])+" "+String(y[i])+" --- "+String(y.length)+" "+String(i))
                    if(x[i]!==y[i]){
                        return {"Pos":String(i),"Change":String(1),"Char":String(y[i])}
                    }
                    else if(i===y.length-1){
                        return {"Pos":String(i+1),"Change":String(1),"Char":String(y[y.length])}
                    }
                }
            }
            return {"Error":"Something went completely wrong"} 
        }

        function onTextUpdate(e){
            let results = compareString(last_input, e.value)
            console.log(results)
            globalThis.last_input = e.value;

            //post the results to back end
            xhr.open('POST', '/api/update', false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(results);
            console.log(JSON.parse(xhr.responseText));
        }

        TextUpdateHeavy = function(e){
            SendData(e.value)
            globalThis.last_input = e.value;
        }

        TextUpdateLeightWeight = function (e){
            if(last_input!=null){
                new_data = GetTextUpdate(e.value, last_input)
                console.log(new_data)
                globalThis.last_input = e.value;
            }
            else{
                new_data = e.value
                console.log(new_data)
                globalThis.last_input = e.value;
            }
            SendData(new_data);
        }

        function GetTextUpdate(a, b){
            if(a.length > b.length){
                return {
                    intersection: a.replace(b, ''),
                    second: 1,
                    position: b.length
                };
            }
            else if(a.length < b.length){
                return {
                    intersection: b.replace(a, ''),
                    second: -1,
                    position: a.length
                };
            }
        }

        function SendData(data){
            xhr.open('POST', '/api/create', false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send( null );
            console.log(JSON.parse(xhr.responseText));
        }
    </script>
</head>
<body style="background-color: black; margin: 25px;">
    <div class="ThreeDots">
        
    </div>
    <h1>Real Time Texteditor</h1>
    <textarea id="textarea" placeholder="Just write ..." oninput="onTextUpdate(this)"></textarea>
</body>
</html>